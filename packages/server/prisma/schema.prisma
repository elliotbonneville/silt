// Prisma schema for Silt
// Database: SQLite for Iteration 1-2, PostgreSQL for Iteration 3+

generator client {
  provider = "prisma-client-js"
}

generator zod {
  provider = "zod-prisma-types"
  output   = "../src/database/generated"
  useMultipleFiles = false
  createInputTypes = false
  createModelTypes = true
  addInputTypeValidation = false
  addIncludeType = false
  addSelectType = false
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Account model (stub for Phase II - auth)
model Account {
  id        String      @id @default(cuid())
  username  String      @unique
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  
  // UI Preferences
  themePreset      String @default("classic")      // 'classic', 'modern', 'dark', 'light'
  fontFamily       String @default("courier-new") // Font key from FONT_FAMILIES
  fontSize         Int    @default(14)             // 12-20px
  lineWidth        Int    @default(80)             // 60-120 characters
  customColorsJson String @default("{}")           // Custom color overrides
  
  characters Character[]
  
  @@map("accounts")
}

// Character model - players create characters that can die permanently
model Character {
  id            String   @id @default(cuid())
  name          String
  description   String   @default("") // Visible when examined
  accountId     String?
  currentRoomId String
  spawnPointId  String?  // References spawn point item (players only, NPCs can be null)
  
  // Stats
  hp            Int      @default(100)
  maxHp         Int      @default(100)
  attackPower   Int      @default(10)
  defense       Int      @default(5)
  
  // State
  isAlive       Boolean  @default(true)
  isDead        Boolean  @default(false) // Redundant but explicit for queries
  lastActionAt  DateTime @default(now())
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  diedAt        DateTime?
  
  account       Account? @relation(fields: [accountId], references: [id], onDelete: Cascade)
  inventory     Item[]
  logs          PlayerLog[]
  
  @@index([accountId])
  @@index([isAlive])
  @@index([currentRoomId])
  @@map("characters")
}

// Room model - game world locations
model Room {
  id          String   @id @default(cuid())
  name        String
  description String
  
  // Map stored as JSON: { "north": "room-id", "east": "room-id" }
  exitsJson   String   @default("{}")
  
  // Metadata
  isStarting  Boolean  @default(false)
  createdBy   String?  // AccountId for admin tracking
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  items       Item[]
  
  @@index([isStarting])
  @@map("rooms")
}

// Item model - weapons, armor, consumables, etc.
model Item {
  id          String   @id @default(cuid())
  name        String
  description String
  itemType    String   // 'weapon' | 'armor' | 'consumable' | 'misc'
  
  // Stats (JSON: { damage?: number, defense?: number, healing?: number })
  statsJson   String   @default("{}")
  
  // Location - either in a room or character's inventory
  roomId      String?
  characterId String?
  
  // Equipment state
  isEquipped  Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  room        Room?      @relation(fields: [roomId], references: [id], onDelete: Cascade)
  character   Character? @relation(fields: [characterId], references: [id], onDelete: Cascade)
  
  @@index([roomId])
  @@index([characterId])
  @@map("items")
}

// GameEvent model - comprehensive event log for debugging and replay
// Includes both game events (speech, combat) and AI events (decisions, actions)
model GameEvent {
  id            String   @id @default(cuid())
  type          String   // Event type: movement, combat, speech, ai:decision, ai:action, etc.
  timestamp     DateTime @default(now())
  originRoomId  String
  
  // Event content
  content       String?
  dataJson      String?  // Flexible metadata as JSON
  
  // Visibility
  visibility    String   // 'room' | 'global' | 'private'
  attenuated    Boolean  @default(false)
  
  @@index([timestamp])
  @@index([type])
  @@index([originRoomId])
  @@map("game_events")
}

// PlayerLog model - comprehensive log of what a player saw/did
// Used to reconstruct client state
model PlayerLog {
  id          String   @id @default(cuid())
  characterId String
  
  type        String   // 'command' | 'output' | 'event'
  
  // Payload:
  // - command: the input string
  // - output: the JSON output sent to client
  // - event: the JSON event sent to client (after formatting)
  payload     String   
  
  createdAt   DateTime @default(now())
  
  character   Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  
  @@index([characterId])
  @@index([createdAt])
  @@map("player_logs")
}

// AI Agent model - manages AI-powered NPCs
model AIAgent {
  id                 String   @id @default(cuid())
  characterId        String   @unique
  
  // AI Configuration
  systemPrompt       String   // Personality + backstory
  homeRoomId         String   // Where the agent prefers to stay
  maxRoomsFromHome   Int      @default(2)
  
  // Memory - stored as JSON
  relationshipsJson  String   @default("{}")  // Map of characterId â†’ relationship data
  conversationJson   String   @default("[]")  // Recent conversation history
  eventQueueJson     String   @default("[]")  // Recent events (90s rolling window)
  spatialMemory      String   @default("")    // LLM-encoded mental map (refreshed periodically)
  spatialMemoryUpdatedAt DateTime @default(now())
  
  // Action tracking
  lastActionAt       DateTime @default(now())
  
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  
  @@index([characterId])
  @@map("ai_agents")
}

// GameState model - global game configuration (singleton table)
model GameState {
  id        String   @id @default("singleton") // Always use same ID for singleton
  isPaused  Boolean  @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("game_state")
}
